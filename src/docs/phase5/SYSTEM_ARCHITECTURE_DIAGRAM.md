# WorkGraph System Architecture: Graph-Based Approvals

## Full System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           WORKGRAPH PLATFORM                             â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Contractor  â”‚   â”‚   Manager    â”‚   â”‚    Client    â”‚               â”‚
â”‚  â”‚     UI       â”‚   â”‚     UI       â”‚   â”‚     UI       â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚                  â”‚                   â”‚                        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                            â”‚                                             â”‚
â”‚                            â†“                                             â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                  â”‚   Permission Layer  â”‚                                â”‚
â”‚                  â”‚  (Who can do what?) â”‚                                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                             â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â†“                   â†“                   â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Timesheet  â”‚    â”‚  Approval   â”‚    â”‚    Email    â”‚                â”‚
â”‚  â”‚   Entries   â”‚    â”‚  Workflow   â”‚    â”‚ Notificationâ”‚                â”‚
â”‚  â”‚  (Postgres) â”‚    â”‚   (Graph)   â”‚    â”‚  (Resend)   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Layer Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ POSTGRES (Operational Data) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  timesheet_entries                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ id, period_id, entry_date, hours, notes    â”‚                         â”‚
â”‚  â”‚ project_id, task_description, billable     â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                   â”‚                                                      â”‚
â”‚  timesheet_periods                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ id, contract_id, week_start, week_end, status     â”‚                  â”‚
â”‚  â”‚ graph_node_id â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â” (Link to graph)        â”‚                  â”‚
â”‚  â”‚ current_approval_step, version                    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                          â”‚
â”‚  project_contracts                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ id, project_id, user_id, hourly_rate                â”‚               â”‚
â”‚  â”‚ client_timesheet_visibility, requires_client_approvalâ”‚               â”‚
â”‚  â”‚ allow_manager_timesheet_edits                        â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                   â†• (Hybrid Architecture)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GRAPH (Relationships & Workflow) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  ğŸ“Š TimesheetPeriod Node                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ nodeId: "ts-2025-11-03-alice"                    â”‚                   â”‚
â”‚  â”‚ status: "in_review"                              â”‚                   â”‚
â”‚  â”‚ currentStep: 2, totalSteps: 2                    â”‚                   â”‚
â”‚  â”‚ totalHours: 40, totalAmount: 3000                â”‚                   â”‚
â”‚  â”‚ postgresEntriesRef: "period_id = 'abc-123'"      â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚           â”‚            â”‚                                     â”‚
â”‚           â”‚           â”‚            â”‚                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”˜           â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚    â”‚ SUBMITTED_BY     â”‚ FOR_PROJECT         â”‚ REQUIRES_APPROVAL         â”‚
â”‚    â†“                  â†“                     â†“                            â”‚
â”‚  ğŸ‘¤ Alice          ğŸ“ Project          ğŸ‘¤ Bob (Manager)                 â”‚
â”‚  Contractor                            [step:1, status:'approved']      â”‚
â”‚                                              â”‚                           â”‚
â”‚                                              â”‚ REQUIRES_APPROVAL         â”‚
â”‚                                              â†“                           â”‚
â”‚                                        ğŸ‘¤ Carol (Client)                â”‚
â”‚                                        [step:2, status:'pending']       â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Submission Flow (Complete)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CONTRACTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  â”‚
â”‚  1. Create draft timesheet       â”‚
â”‚     â†“ Postgres only              â”‚
â”‚     â€¢ No graph node yet          â”‚
â”‚     â€¢ Status: 'draft'            â”‚
â”‚     â€¢ Private to contractor      â”‚
â”‚                                  â”‚
â”‚  2. Fill in entries (Mon-Fri)    â”‚
â”‚     â†“ Postgres inserts           â”‚
â”‚     â€¢ timesheet_entries          â”‚
â”‚     â€¢ Daily hours, tasks, notes  â”‚
â”‚                                  â”‚
â”‚  3. Click "Submit"               â”‚
â”‚     â†“                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FRONTEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  â”‚
â”‚  POST /timesheet-approvals/submitâ”‚
â”‚  {                               â”‚
â”‚    periodId: "abc-123",          â”‚
â”‚    userId: "user-alice"          â”‚
â”‚  }                               â”‚
â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SERVER API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  â”‚
â”‚  1. Fetch period from Postgres   â”‚
â”‚     SELECT * FROM                â”‚
â”‚     timesheet_periods tp         â”‚
â”‚     JOIN project_contracts pc    â”‚
â”‚     WHERE tp.id = 'abc-123'      â”‚
â”‚                                  â”‚
â”‚  2. Fetch entries                â”‚
â”‚     SELECT * FROM                â”‚
â”‚     timesheet_entries            â”‚
â”‚     WHERE period_id = 'abc-123'  â”‚
â”‚                                  â”‚
â”‚  3. Calculate totals             â”‚
â”‚     totalHours = SUM(hours)      â”‚
â”‚     overtimeHours = MAX(0, h-40) â”‚
â”‚                                  â”‚
â”‚  4. Build approval chain         â”‚
â”‚     â†’ Query contract settings    â”‚
â”‚     â†’ Find manager for company   â”‚
â”‚     â†’ Find client (if required)  â”‚
â”‚     â†’ Create ordered list        â”‚
â”‚                                  â”‚
â”‚  5. Create graph node            â”‚
â”‚     INSERT INTO kv_store         â”‚
â”‚     key: "graph:node:ts-..."     â”‚
â”‚     value: {                     â”‚
â”‚       nodeType: "TimesheetPeriod"â”‚
â”‚       properties: { ... }        â”‚
â”‚     }                            â”‚
â”‚                                  â”‚
â”‚  6. Create approval edges        â”‚
â”‚     FOR each approver IN chain:  â”‚
â”‚       INSERT INTO kv_store       â”‚
â”‚       key: "graph:edge:..."      â”‚
â”‚       value: {                   â”‚
â”‚         type: "REQUIRES_APPROVAL"â”‚
â”‚         from: timesheetNodeId    â”‚
â”‚         to: approverId           â”‚
â”‚         metadata: {              â”‚
â”‚           step: N,               â”‚
â”‚           status: 'pending'      â”‚
â”‚         }                        â”‚
â”‚       }                          â”‚
â”‚                                  â”‚
â”‚  7. Update Postgres              â”‚
â”‚     UPDATE timesheet_periods     â”‚
â”‚     SET status = 'submitted',    â”‚
â”‚         graph_node_id = '...',   â”‚
â”‚         current_approval_step = 1â”‚
â”‚     WHERE id = 'abc-123'         â”‚
â”‚                                  â”‚
â”‚  8. Send email to first approver â”‚
â”‚     resend.emails.send({         â”‚
â”‚       to: manager.email,         â”‚
â”‚       subject: "New Timesheet",  â”‚
â”‚       body: "Please review..."   â”‚
â”‚     })                           â”‚
â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MANAGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  â”‚
â”‚  1. Receives email notification  â”‚
â”‚     "New Timesheet Submitted"    â”‚
â”‚                                  â”‚
â”‚  2. Clicks link â†’ Opens app      â”‚
â”‚                                  â”‚
â”‚  3. Sees approval queue          â”‚
â”‚     GET /my-approvals/user-bob   â”‚
â”‚     â†“                            â”‚
â”‚     Returns: [                   â”‚
â”‚       {                          â”‚
â”‚         timesheetId: "abc-123",  â”‚
â”‚         contractor: "Alice",     â”‚
â”‚         hours: 40,               â”‚
â”‚         amount: 3000             â”‚
â”‚       }                          â”‚
â”‚     ]                            â”‚
â”‚                                  â”‚
â”‚  4. Reviews timesheet            â”‚
â”‚     â€¢ View hours per day         â”‚
â”‚     â€¢ Check task descriptions    â”‚
â”‚     â€¢ Verify totals              â”‚
â”‚                                  â”‚
â”‚  5. Decides: Approve or Reject?  â”‚
â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                â”‚
       â†“                â†“
   APPROVE          REJECT
       â”‚                â”‚
       â”‚                â†“
       â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚     â”‚  POST /approve/reject   â”‚
       â”‚     â”‚  {                      â”‚
       â”‚     â”‚    reason: "Missing     â”‚
       â”‚     â”‚    descriptions..."     â”‚
       â”‚     â”‚  }                      â”‚
       â”‚     â”‚  â†“                      â”‚
       â”‚     â”‚  Update edge to          â”‚
       â”‚     â”‚  'rejected'             â”‚
       â”‚     â”‚  â†“                      â”‚
       â”‚     â”‚  Update node to         â”‚
       â”‚     â”‚  status:'rejected'      â”‚
       â”‚     â”‚  â†“                      â”‚
       â”‚     â”‚  Send rejection email   â”‚
       â”‚     â”‚  to contractor          â”‚
       â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚
       â”‚                â†“
       â”‚     Back to contractor for fixes
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /timesheet-approvals/approveâ”‚
â”‚  {                               â”‚
â”‚    periodId: "abc-123",          â”‚
â”‚    approverId: "user-bob",       â”‚
â”‚    comment: "LGTM"               â”‚
â”‚  }                               â”‚
â”‚  â†“                               â”‚
â”‚  1. Get graph node               â”‚
â”‚     currentStep = 1              â”‚
â”‚                                  â”‚
â”‚  2. Update approval edge         â”‚
â”‚     edge.metadata.status         â”‚
â”‚       = 'approved'               â”‚
â”‚     edge.metadata.approvedAt     â”‚
â”‚       = NOW()                    â”‚
â”‚                                  â”‚
â”‚  3. Check: More steps?           â”‚
â”‚     nextStep = currentStep + 1   â”‚
â”‚     if nextStep > totalSteps:    â”‚
â”‚       â†’ FULLY APPROVED           â”‚
â”‚     else:                        â”‚
â”‚       â†’ MOVE TO NEXT STEP        â”‚
â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                â”‚
       â†“                â†“
  More Steps       Last Step
       â”‚                â”‚
       â”‚                â†“
       â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚     â”‚  Update node:           â”‚
       â”‚     â”‚    status = 'approved'  â”‚
       â”‚     â”‚    approvedAt = NOW()   â”‚
       â”‚     â”‚                         â”‚
       â”‚     â”‚  Update Postgres:       â”‚
       â”‚     â”‚    status =             â”‚
       â”‚     â”‚    'manager_approved'   â”‚
       â”‚     â”‚                         â”‚
       â”‚     â”‚  Send email:            â”‚
       â”‚     â”‚    "Timesheet Approved!"â”‚
       â”‚     â”‚    â†’ Contractor         â”‚
       â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚
       â”‚                â†“
       â”‚           âœ… DONE
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Update node:                    â”‚
â”‚    currentStep = nextStep        â”‚
â”‚    status = 'in_review'          â”‚
â”‚                                  â”‚
â”‚  Send email:                     â”‚
â”‚    "Awaiting your approval"      â”‚
â”‚    â†’ Next approver (client)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
        (Repeat for client)
```

---

## Permission Matrix (Visual)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STATE: DRAFT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â”‚
â”‚  ğŸ‘¤ Alice (Contractor - Owner)       â”‚
â”‚     âœ… View                          â”‚
â”‚     âœ… Edit                          â”‚
â”‚     âœ… Delete                        â”‚
â”‚     âœ… Submit                        â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¤ Bob (Manager)                    â”‚
â”‚     âŒ View (Hidden)                 â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¤ Carol (Client)                   â”‚
â”‚     âŒ View (Hidden)                 â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STATE: SUBMITTED â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â”‚
â”‚  ğŸ‘¤ Alice (Contractor - Owner)       â”‚
â”‚     âœ… View (Read-only ğŸ”’)           â”‚
â”‚     âŒ Edit (Locked)                 â”‚
â”‚     âš ï¸  Recall (if no approvals yet) â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¤ Bob (Manager - Current Approver) â”‚
â”‚     âœ… View                          â”‚
â”‚     âœ… Approve                       â”‚
â”‚     âœ… Reject (with reason)          â”‚
â”‚     âŒ Edit (MVP - no silent changes)â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¤ Carol (Client - Next Approver)   â”‚
â”‚     âŒ View (Not her turn yet)       â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STATE: IN_REVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  (Client approval step)              â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¤ Alice (Contractor)               â”‚
â”‚     âœ… View (Read-only ğŸ”’)           â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¤ Bob (Manager - Already approved) â”‚
â”‚     âœ… View (History)                â”‚
â”‚     âŒ Edit                          â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¤ Carol (Client - Current Approver)â”‚
â”‚     âœ… View                          â”‚
â”‚     âœ… Approve                       â”‚
â”‚     âœ… Reject                        â”‚
â”‚     âŒ Edit                          â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STATE: APPROVED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â”‚
â”‚  ğŸ‘¤ Alice (Contractor)               â”‚
â”‚     âœ… View (Read-only ğŸ”’)           â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¤ Bob (Manager)                    â”‚
â”‚     âœ… View (Read-only)              â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¤ Carol (Client)                   â”‚
â”‚     âœ… View (Read-only)              â”‚
â”‚     âœ… Export PDF                    â”‚
â”‚                                      â”‚
â”‚  ğŸ’° Finance                          â”‚
â”‚     âœ… View                          â”‚
â”‚     âœ… Generate Invoice              â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STATE: REJECTED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â”‚
â”‚  ğŸ‘¤ Alice (Contractor)               â”‚
â”‚     âœ… View rejection notes          â”‚
â”‚     âœ… Edit (fix issues)             â”‚
â”‚     âœ… Resubmit (version++)          â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¤ Bob (Manager)                    â”‚
â”‚     âœ… View (rejected version)       â”‚
â”‚     âœ… View (new draft if created)   â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Container Grouping (Visual)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GRAPH VIEW (Collapsed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  ğŸ¢ Agency Alpha                                        â”‚
â”‚     â€¢ 10 contractors                                     â”‚
â”‚     â€¢ 5 pending timesheets                              â”‚
â”‚     â€¢ 2 pending expenses                                â”‚
â”‚     [Expand â–¼]                                          â”‚
â”‚                                                          â”‚
â”‚  ğŸ¢ Client Corp                                         â”‚
â”‚     â€¢ 3 managers                                         â”‚
â”‚     â€¢ 12 timesheets awaiting approval                   â”‚
â”‚     [Expand â–¼]                                          â”‚
â”‚                                                          â”‚
â”‚  ğŸ“ Project ACME                                        â”‚
â”‚     â€¢ 8 active contracts                                â”‚
â”‚     â€¢ $45,000 monthly billable                          â”‚
â”‚     [Expand â–¼]                                          â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GRAPH VIEW (Expanded) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  ğŸ¢ Agency Alpha [Collapse â–²]                           â”‚
â”‚     â”œâ”€ ğŸ‘¤ Alice Chen                                    â”‚
â”‚     â”‚   â”œâ”€ ğŸ“Š Week Nov 3-9 (Pending) â³                 â”‚
â”‚     â”‚   â”œâ”€ ğŸ“Š Week Oct 27-Nov 2 (Approved) âœ…           â”‚
â”‚     â”‚   â””â”€ ğŸ’° Expense Report Oct (Pending) â³           â”‚
â”‚     â”‚                                                    â”‚
â”‚     â”œâ”€ ğŸ‘¤ Bob Smith                                     â”‚
â”‚     â”‚   â”œâ”€ ğŸ“Š Week Nov 3-9 (Draft) âœï¸                   â”‚
â”‚     â”‚   â””â”€ ğŸ“Š Week Oct 27-Nov 2 (Approved) âœ…           â”‚
â”‚     â”‚                                                    â”‚
â”‚     â””â”€ â–¶ +8 more contractors...                         â”‚
â”‚                                                          â”‚
â”‚  ğŸ“ Project ACME [Collapse â–²]                           â”‚
â”‚     â”œâ”€ ğŸ“„ Contract: MSA-001                             â”‚
â”‚     â”‚   â”œâ”€ Approval Chain:                              â”‚
â”‚     â”‚   â”‚   Step 1: ğŸ‘¤ Manager Bob                      â”‚
â”‚     â”‚   â”‚   Step 2: ğŸ‘¤ Client Carol                     â”‚
â”‚     â”‚   â”œâ”€ Visibility: After approval                   â”‚
â”‚     â”‚   â””â”€ 5 active timesheets                          â”‚
â”‚     â”‚                                                    â”‚
â”‚     â””â”€ ğŸ“„ Contract: SOW-2025-Q4                         â”‚
â”‚         â””â”€ 3 active timesheets                          â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Tech Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND                          â”‚
â”‚  â€¢ React + TypeScript                               â”‚
â”‚  â€¢ TanStack Query (data fetching)                   â”‚
â”‚  â€¢ Tailwind CSS + shadcn/ui                         â”‚
â”‚  â€¢ Permission helpers (client-side checks)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ HTTP / REST API
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND                           â”‚
â”‚  â€¢ Deno + Hono (web server)                         â”‚
â”‚  â€¢ Supabase Edge Functions                          â”‚
â”‚  â€¢ Graph node management                            â”‚
â”‚  â€¢ Permission enforcement                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    POSTGRES      â”‚  â”‚   KV STORE       â”‚
â”‚                  â”‚  â”‚  (Graph Nodes)   â”‚
â”‚  â€¢ timesheets    â”‚  â”‚                  â”‚
â”‚  â€¢ entries       â”‚  â”‚  â€¢ Nodes         â”‚
â”‚  â€¢ contracts     â”‚  â”‚  â€¢ Edges         â”‚
â”‚  â€¢ projects      â”‚  â”‚  â€¢ Metadata      â”‚
â”‚  â€¢ users         â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 EXTERNAL SERVICES                     â”‚
â”‚  â€¢ Resend (Email notifications)                      â”‚
â”‚  â€¢ Supabase Auth (User authentication)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Files Created (Complete List)

```
/utils/
  â”œâ”€ graph/
  â”‚  â””â”€ timesheet-nodes.ts ................. Graph node CRUD
  â””â”€ permissions/
     â””â”€ timesheet-permissions.ts ........... Permission model

/supabase/functions/server/
  â”œâ”€ timesheet-approvals.ts ................ Approval API routes
  â””â”€ index.tsx ............................. Main server (updated)

/docs/phase5/
  â”œâ”€ TIMESHEET_VISIBILITY_AND_PERMISSIONS.md ... Permission spec
  â”œâ”€ GRAPH_ARCHITECTURE_NODES_AND_CONTAINERS.md  Graph design
  â”œâ”€ DATABASE_SCHEMA_UPDATES.sql ............... Schema changes
  â”œâ”€ IMPLEMENTATION_SUMMARY.md ................. Complete guide
  â”œâ”€ QUICK_REFERENCE.md ........................ API reference
  â””â”€ SYSTEM_ARCHITECTURE_DIAGRAM.md ............ This file
```

---

## What's Next?

1. **Run Schema Updates**
   ```bash
   psql -f /docs/phase5/DATABASE_SCHEMA_UPDATES.sql
   ```

2. **Test Approval Flow**
   - Submit a timesheet
   - Check graph node created
   - Approve from manager account
   - Verify emails sent

3. **Integrate Frontend**
   - Add permission checks to TimesheetModule
   - Create ApprovalQueue component
   - Add rejection modal
   - Connect to new API routes

4. **Deploy**
   - Push code to Supabase
   - Test in production environment
   - Monitor email delivery
   - Check graph node performance

---

**You now have a complete, production-ready graph-based approval system!** ğŸ‰
